name: Release Binaries

on:
  push:
    tags:
      - "v*" # Trigger only when a tag starting with "v" is pushed, e.g. v1.2.3

permissions:
  contents: write

jobs:
  checks:
    name: Pre-release checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify tag matches Cargo.toml version
        shell: bash
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')

          echo "Tag version: $TAG_VERSION"
          echo "Cargo.toml version: $CARGO_VERSION"

          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "❌ Version mismatch: tag ($TAG_VERSION) != Cargo.toml ($CARGO_VERSION)"
            exit 1
          fi

          echo "✅ Tag and Cargo.toml version match."

  build:
    name: Build for ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    needs: checks
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            ext: ""
          - os: windows-latest
            arch: x86_64
            target: x86_64-pc-windows-msvc
            ext: ".exe"
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin
            ext: ""
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            ext: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install ARM toolchain and et up Cargo config for cross-compilation
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt update && sudo apt install -y gcc-aarch64-linux-gnu
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-gnu]' > .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml
          rustup target add aarch64-unknown-linux-gnu

      - name: Install Deps to build linux packages
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo install cargo-deb cargo-generate-rpm

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare artifact (all OS)
        shell: bash
        run: |
          mkdir -p artifacts
          BIN_DIR="target/${{ matrix.target }}/release"

          # récupère tous les binaires exécutables dans BIN_DIR
          BIN_LIST=$(find "$BIN_DIR" -maxdepth 1 -type f -perm -111 | xargs -n1 basename)
          echo "Found binaries: $BIN_LIST"
          # nom de l'archive avec le tag
          case "${{ matrix.os }}" in
            windows-latest)
              ARCHIVE_NAME="coretilus-${{ github.ref_name }}-windows_${{ matrix.arch }}.zip"
              # construit un tableau PowerShell avec tous les fichiers (format correct)
              BIN_ARRAY=""
              for bin in $BIN_LIST; do
                BIN_ARRAY+="'$BIN_DIR/$bin',"
              done
              # retire la dernière virgule
              BIN_ARRAY=${BIN_ARRAY%,}
              pwsh -Command "Compress-Archive -Path @($BIN_ARRAY) -DestinationPath 'artifacts/$ARCHIVE_NAME' -Force"
              ;;
            ubuntu-latest)
              ARCHIVE_NAME="coretilus-${{ github.ref_name }}-linux_${{ matrix.arch }}.tar.gz"
              tar -czf "artifacts/$ARCHIVE_NAME" -C "$BIN_DIR" $BIN_LIST
              cargo deb --target ${{ matrix.target }}
              cp -v target/debian/*.deb artifacts/
              cargo generate-rpm --target ${{ matrix.target }}
              cp -v target/${{ matrix.target }}/generate-rpm/*.rpm artifacts/
              ;;
            macos-latest)
              ARCHIVE_NAME="coretilus-${{ github.ref_name }}-macos_${{ matrix.arch }}.tar.gz"
              tar -czf "artifacts/$ARCHIVE_NAME" -C "$BIN_DIR" $BIN_LIST
              ;;
            *)
              echo "Unsupported OS: ${{ matrix.os }}"
              exit 1
              ;;
          esac

          echo "Created artifact: artifacts/$ARCHIVE_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: artifacts/

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: release
    permissions:
      id-token: write
      contents: read
    environment:
      name: crates-io
      url: https://crates.io/crates/coretilus
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - uses: rust-lang/crates-io-auth-action@v1
        id: auth
      - name: Publish to crates.io
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ steps.auth.outputs.token }}
